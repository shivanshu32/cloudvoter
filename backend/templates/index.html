<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudVoter - Automated Voting System</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .log-entry {
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .log-entry:hover {
            background-color: #f9fafb;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            color: #111827;
        }
        
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .session-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .session-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">CloudVoter</h1>
                            <p class="text-sm text-gray-500">Automated Voting System</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="connection-status" class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <span class="text-sm text-gray-600">Connecting...</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <nav class="flex border-b border-gray-200">
                    <button class="tab-btn active" onclick="switchTab('dashboard')">
                        <span class="flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <span>Dashboard</span>
                        </span>
                    </button>
                    <button class="tab-btn" onclick="switchTab('sessions')">
                        <span class="flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                            <span>Sessions</span>
                        </span>
                    </button>
                    <button class="tab-btn" onclick="switchTab('browsers')">
                        <span class="flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <span>Opened Browsers</span>
                        </span>
                    </button>
                    <button class="tab-btn" onclick="switchTab('login-required')">
                        <span class="flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            <span>Login Required</span>
                        </span>
                    </button>
                    <button class="tab-btn" onclick="switchTab('logs')">
                        <span class="flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>Logs</span>
                        </span>
                    </button>
                </nav>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
            <!-- Control Panel -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Control Panel</h2>
                    <button id="start-btn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Start Monitoring</span>
                    </button>
                    <button id="stop-btn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors duration-200 hidden flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                        </svg>
                        <span>Stop Monitoring</span>
                    </button>
                </div>

                <!-- Configuration -->
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <!-- Voting URL Section -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Voting URL</label>
                        <div class="flex gap-2">
                            <input type="text" id="voting-url" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="https://www.cutebabyvote.com/...">
                            <button id="save-url-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium whitespace-nowrap">
                                üíæ Save URL
                            </button>
                        </div>
                        <p id="url-save-status" class="text-sm mt-2 hidden"></p>
                    </div>
                    
                    <!-- Bright Data Credentials Section -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bright Data Credentials</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Username</label>
                                <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="username">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Password</label>
                                <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="password">
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="save-credentials-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                                üíæ Save Credentials
                            </button>
                            <p id="credentials-save-status" class="text-sm my-auto hidden"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Attempts</p>
                            <p id="stat-total" class="text-2xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Successful Votes</p>
                            <p id="stat-success" class="text-2xl font-bold text-green-600 mt-1">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Failed Votes</p>
                            <p id="stat-failed" class="text-2xl font-bold text-red-600 mt-1">0</p>
                        </div>
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Active Instances</p>
                            <p id="stat-active" class="text-2xl font-bold text-purple-600 mt-1">0</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instances and Logs -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Active Instances -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Active Instances</h3>
                    </div>
                    <div id="instances-container" class="p-4 max-h-96 overflow-y-auto">
                        <p class="text-sm text-gray-500 text-center py-8">No active instances</p>
                    </div>
                </div>

                <!-- Live Logs -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Live Logs</h3>
                        <button id="clear-logs" class="text-sm text-gray-600 hover:text-gray-900">Clear</button>
                    </div>
                    <div id="logs-container" class="max-h-96 overflow-y-auto">
                        <p class="text-sm text-gray-500 text-center py-8">No logs yet</p>
                    </div>
                </div>
            </div>
            </div>
            <!-- End Dashboard Tab -->

            <!-- Sessions Tab -->
            <div id="sessions-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-gray-900">Saved Sessions</h2>
                        <span id="sessions-count" class="text-sm text-gray-600">Loading...</span>
                    </div>
                    <div id="sessions-list" class="space-y-4">
                        <p class="text-center text-gray-500 py-8">Loading sessions...</p>
                    </div>
                </div>
            </div>
            <!-- End Sessions Tab -->

            <!-- Opened Browsers Tab -->
            <div id="browsers-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Opened Browsers</h2>
                            <p class="text-sm text-gray-500 mt-1">Real-time tracking of headless browser instances</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="browsers-count" class="text-sm font-medium text-gray-600">
                                <span class="text-2xl font-bold text-blue-600" id="open-browsers-count">0</span> browsers open
                            </span>
                        </div>
                    </div>
                    <div id="browsers-list" class="space-y-3">
                        <p class="text-center text-gray-500 py-8">No browsers currently open</p>
                    </div>
                </div>
            </div>
            <!-- End Opened Browsers Tab -->

            <!-- Login Required Tab -->
            <div id="login-required-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Login Required Instances</h2>
                            <p class="text-sm text-gray-500 mt-1">Instances that need Google login (excluded from voting cycles)</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="login-required-count" class="text-sm font-medium text-gray-600">
                                <span class="text-2xl font-bold text-red-600" id="login-required-instances-count">0</span> instances
                            </span>
                        </div>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start space-x-3">
                            <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <div class="flex-1">
                                <h3 class="text-sm font-medium text-yellow-800">‚ö†Ô∏è Manual Login Required</h3>
                                <p class="text-sm text-yellow-700 mt-1">These instances detected "Login with Google" button and have been excluded from voting cycles. Restart the script to re-enable them after logging in manually.</p>
                            </div>
                        </div>
                    </div>
                    <div id="login-required-list" class="space-y-3">
                        <p class="text-center text-gray-500 py-8">No instances require login</p>
                    </div>
                </div>
            </div>
            <!-- End Login Required Tab -->

            <!-- Logs Tab -->
            <div id="logs-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">All Logs</h3>
                        <button id="clear-all-logs" class="text-sm text-gray-600 hover:text-gray-900">Clear</button>
                    </div>
                    <div id="all-logs-container" class="max-h-screen overflow-y-auto p-4">
                        <p class="text-sm text-gray-500 text-center py-8">No logs yet</p>
                    </div>
                </div>
            </div>
            <!-- End Logs Tab -->
        </main>
    </div>

    <!-- Save Login Modal -->
    <div id="save-login-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Save Google Login</h3>
            <p class="text-sm text-gray-600 mb-4">
                A browser window will open. Please:
            </p>
            <ol class="list-decimal list-inside text-sm text-gray-600 space-y-2 mb-6">
                <li>Log into your Google account</li>
                <li>Complete any 2FA verification</li>
                <li>Click "Done" below when finished</li>
            </ol>
            <div class="flex space-x-3">
                <button id="cancel-login-btn" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button id="complete-login-btn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Done - Save Session
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = window.location.origin;
        let socket = null;
        let monitoringActive = false;

        // DOM Elements
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const votingUrlInput = document.getElementById('voting-url');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const connectionStatus = document.getElementById('connection-status');
        const logsContainer = document.getElementById('logs-container');
        const instancesContainer = document.getElementById('instances-container');
        const clearLogsBtn = document.getElementById('clear-logs');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            restoreLogs();  // Restore logs from localStorage
            initializeSocket();
            loadConfiguration();
            setupEventListeners();
            checkMonitoringStatus();  // Check if monitoring is already running
            startPolling();
        });

        // Socket.IO Connection
        function initializeSocket() {
            socket = io(API_URL);

            socket.on('connect', () => {
                updateConnectionStatus(true);
                addLog('üîå Connected to CloudVoter server');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus(false);
                addLog('‚ö†Ô∏è Disconnected from server');
            });

            socket.on('log', (data) => {
                addLog(data.message);
            });

            socket.on('log_update', (data) => {
                addLog(data.message);
            });

            socket.on('status_update', (data) => {
                monitoringActive = data.monitoring_active;
                updateButtons();
            });
            
            socket.on('statistics_update', (data) => {
                // Update statistics in real-time via Socket.IO
                document.getElementById('stat-total').textContent = data.total_attempts || 0;
                document.getElementById('stat-success').textContent = data.successful_votes || 0;
                document.getElementById('stat-failed').textContent = data.failed_votes || 0;
                document.getElementById('stat-active').textContent = data.active_instances || 0;
            });
            
            socket.on('instances_update', (data) => {
                // Update instances in real-time via Socket.IO
                if (data.instances && data.instances.length > 0) {
                    renderInstances(data.instances);
                } else {
                    instancesContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No active instances</p>';
                }
            });
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusDot = connectionStatus.querySelector('div');
            const statusText = connectionStatus.querySelector('span');
            
            if (connected) {
                statusDot.className = 'w-2 h-2 bg-green-500 rounded-full pulse';
                statusText.textContent = 'Connected';
                statusText.className = 'text-sm text-green-600';
            } else {
                statusDot.className = 'w-2 h-2 bg-red-500 rounded-full';
                statusText.textContent = 'Disconnected';
                statusText.className = 'text-sm text-red-600';
            }
        }

        // Load configuration
        async function loadConfiguration() {
            try {
                const response = await fetch(`${API_URL}/api/config`);
                const data = await response.json();
                
                votingUrlInput.value = data.voting_url || '';
                usernameInput.value = data.bright_data_username || '';
                passwordInput.value = data.bright_data_password || '';
                
                addLog('‚úÖ Configuration loaded successfully');
            } catch (error) {
                console.error('Error loading config:', error);
                addLog('‚ö†Ô∏è Could not load configuration');
            }
        }

        // Save Voting URL
        async function saveVotingUrl() {
            const urlInput = document.getElementById('voting-url');
            const statusElement = document.getElementById('url-save-status');
            const saveBtn = document.getElementById('save-url-btn');
            
            const votingUrl = urlInput.value.trim();
            
            if (!votingUrl) {
                showStatus(statusElement, '‚ö†Ô∏è Please enter a voting URL', 'text-orange-600');
                return;
            }
            
            // Basic URL validation
            try {
                new URL(votingUrl);
            } catch (e) {
                showStatus(statusElement, '‚ùå Invalid URL format', 'text-red-600');
                return;
            }
            
            // Disable button during save
            saveBtn.disabled = true;
            saveBtn.textContent = 'üíæ Saving...';
            
            try {
                const response = await fetch(`${API_URL}/api/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        voting_url: votingUrl
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showStatus(statusElement, '‚úÖ Voting URL saved successfully!', 'text-green-600');
                    addLog(`üíæ Voting URL saved: ${votingUrl}`);
                } else {
                    showStatus(statusElement, `‚ùå ${data.message}`, 'text-red-600');
                }
            } catch (error) {
                console.error('Error saving voting URL:', error);
                showStatus(statusElement, '‚ùå Failed to save voting URL', 'text-red-600');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save URL';
            }
        }

        // Save Bright Data Credentials
        async function saveCredentials() {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const statusElement = document.getElementById('credentials-save-status');
            const saveBtn = document.getElementById('save-credentials-btn');
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!username || !password) {
                showStatus(statusElement, '‚ö†Ô∏è Please enter both username and password', 'text-orange-600');
                return;
            }
            
            // Disable button during save
            saveBtn.disabled = true;
            saveBtn.textContent = 'üíæ Saving...';
            
            try {
                const response = await fetch(`${API_URL}/api/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bright_data_username: username,
                        bright_data_password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showStatus(statusElement, '‚úÖ Credentials saved successfully!', 'text-green-600');
                    addLog('üíæ Bright Data credentials saved');
                } else {
                    showStatus(statusElement, `‚ùå ${data.message}`, 'text-red-600');
                }
            } catch (error) {
                console.error('Error saving credentials:', error);
                showStatus(statusElement, '‚ùå Failed to save credentials', 'text-red-600');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save Credentials';
            }
        }

        // Helper function to show status messages
        function showStatus(element, message, className) {
            element.textContent = message;
            element.className = `text-sm mt-2 ${className}`;
            element.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        // Setup event listeners
        function setupEventListeners() {
            startBtn.addEventListener('click', startMonitoring);
            stopBtn.addEventListener('click', stopMonitoring);
            clearLogsBtn.addEventListener('click', clearLogs);
            
            // Save buttons
            document.getElementById('save-url-btn').addEventListener('click', saveVotingUrl);
            document.getElementById('save-credentials-btn').addEventListener('click', saveCredentials);
            
            // Optional: Save on Enter key
            votingUrlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveVotingUrl();
            });
            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveCredentials();
            });
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveCredentials();
            });
        }

        // Start monitoring
        async function startMonitoring() {
            try {
                // Get credentials from inputs
                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();
                const votingUrl = votingUrlInput.value.trim();
                
                // Send credentials in request body
                const response = await fetch(`${API_URL}/api/start-monitoring`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username || undefined,
                        password: password || undefined,
                        voting_url: votingUrl || undefined
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'started') {
                    monitoringActive = true;
                    updateButtons();
                    addLog('üöÄ Ultra monitoring started');
                } else {
                    addLog('‚ö†Ô∏è ' + data.message);
                }
            } catch (error) {
                console.error('Error starting monitoring:', error);
                addLog('‚ùå Failed to start monitoring: ' + error.message);
            }
        }

        // Stop monitoring
        async function stopMonitoring() {
            try {
                const response = await fetch(`${API_URL}/api/stop-monitoring`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.status === 'stopped') {
                    monitoringActive = false;
                    updateButtons();
                    addLog('‚èπ Monitoring stopped');
                } else {
                    addLog('‚ö†Ô∏è ' + data.message);
                }
            } catch (error) {
                console.error('Error stopping monitoring:', error);
                addLog('‚ùå Failed to stop monitoring');
            }
        }

        // Update buttons
        function updateButtons() {
            if (monitoringActive) {
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
            } else {
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
            }
        }

        // Add log entry
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            if (logsContainer.querySelector('p')) {
                logsContainer.innerHTML = '';
            }
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // Keep only last 100 logs
            while (logsContainer.children.length > 100) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
            
            // Save logs to localStorage
            saveLogs();
        }
        
        // Save logs to localStorage
        function saveLogs() {
            try {
                const logs = [];
                logsContainer.querySelectorAll('.log-entry').forEach(entry => {
                    logs.push(entry.textContent);
                });
                localStorage.setItem('cloudvoter_logs', JSON.stringify(logs));
            } catch (error) {
                console.error('Error saving logs:', error);
            }
        }
        
        // Restore logs from localStorage
        function restoreLogs() {
            try {
                const savedLogs = localStorage.getItem('cloudvoter_logs');
                if (savedLogs) {
                    const logs = JSON.parse(savedLogs);
                    if (logs.length > 0) {
                        logsContainer.innerHTML = '';
                        logs.forEach(logText => {
                            const logEntry = document.createElement('div');
                            logEntry.className = 'log-entry';
                            logEntry.textContent = logText;
                            logsContainer.appendChild(logEntry);
                        });
                        logsContainer.scrollTop = logsContainer.scrollHeight;
                    }
                }
            } catch (error) {
                console.error('Error restoring logs:', error);
            }
        }

        // Clear logs
        function clearLogs() {
            logsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No logs yet</p>';
            localStorage.removeItem('cloudvoter_logs');
        }

        // Update statistics
        async function updateStatistics() {
            try {
                const response = await fetch(`${API_URL}/api/statistics`);
                const data = await response.json();
                
                document.getElementById('stat-total').textContent = data.total_attempts || 0;
                document.getElementById('stat-success').textContent = data.successful_votes || 0;
                document.getElementById('stat-failed').textContent = data.failed_votes || 0;
                document.getElementById('stat-active').textContent = data.active_instances || 0;
            } catch (error) {
                console.error('Error updating statistics:', error);
            }
        }

        // Format seconds into MM:SS with retry type
        function formatCountdown(seconds, retryType = null) {
            if (seconds <= 0) return '‚úÖ Ready to vote';
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timeStr = `${minutes}:${secs.toString().padStart(2, '0')}`;
            
            // Show different icons/labels based on retry type
            if (retryType === 'technical') {
                return `üîÑ Retry in ${timeStr}`;
            } else if (retryType === 'ip_cooldown') {
                return `‚è≥ Cooldown ${timeStr}`;
            } else {
                return `‚è≥ Next vote ${timeStr}`;
            }
        }
        
        // Render instances (used by both polling and Socket.IO)
        function renderInstances(instances) {
            if (!instances || instances.length === 0) {
                instancesContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No active instances</p>';
                return;
            }
            
            // Sort instances by instance_id for consistent ordering
            const sortedInstances = instances.sort((a, b) => {
                const idA = typeof a.instance_id === 'number' ? a.instance_id : 999;
                const idB = typeof b.instance_id === 'number' ? b.instance_id : 999;
                return idA - idB;
            });
            
            // Build new HTML
            const newHTML = sortedInstances.map(instance => {
                const instanceId = String(instance.instance_id);
                const secondsRemaining = instance.seconds_remaining || 0;
                const retryType = instance.retry_type || null;
                const countdownText = formatCountdown(secondsRemaining, retryType);
                
                return `
                <div class="mb-3 p-3 bg-gray-50 rounded-lg border border-gray-200" data-instance-id="${instanceId}" data-seconds="${secondsRemaining}" data-retry-type="${retryType || ''}">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-gray-900">Instance #${instance.instance_id}</span>
                        <span class="status-badge ${getStatusColor(instance.status)}">
                            ${instance.status}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        <div>IP: ${instance.ip || 'N/A'}</div>
                        <div>Votes: ${instance.vote_count || 0}</div>
                        ${instance.is_paused ? '<div class="text-orange-600">‚è∏Ô∏è Paused</div>' : ''}
                        <div class="font-semibold ${secondsRemaining > 0 ? (retryType === 'technical' ? 'text-orange-600' : 'text-blue-600') : 'text-green-600'}" data-countdown="${instanceId}">
                            ${countdownText}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-500 mt-2 pt-2 border-t border-gray-200">
                        <div>‚úÖ Last Success: ${formatLastVote(instance.last_successful_vote)}</div>
                        <div>üéØ Last Attempt: ${formatLastVote(instance.last_attempted_vote)}</div>
                    </div>
                    ${instance.last_failure_reason ? `
                    <div class="mt-2 pt-2 border-t border-red-200">
                        <div class="text-xs text-red-600 font-medium">
                            ‚ùå Last Failure: ${instance.last_failure_reason}
                        </div>
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');
            
            // Only update if content changed to avoid flickering
            const currentHTML = instancesContainer.innerHTML.trim();
            const newHTMLTrimmed = newHTML.trim();
            if (currentHTML !== newHTMLTrimmed) {
                instancesContainer.innerHTML = newHTML;
                console.log(`[UI] Updated ${sortedInstances.length} instance cards`);
            }
        }
        
        // Update instances via polling (fallback)
        async function updateInstances() {
            try {
                const response = await fetch(`${API_URL}/api/instances`);
                const data = await response.json();
                
                console.log(`[POLL] Fetched ${data.instances?.length || 0} instances`);
                renderInstances(data.instances);
            } catch (error) {
                console.error('Error updating instances:', error);
            }
        }

        // Get status color
        function getStatusColor(status) {
            if (status.includes('Success') || status.includes('‚úÖ')) return 'bg-green-100 text-green-800';
            if (status.includes('Error') || status.includes('‚ùå')) return 'bg-red-100 text-red-800';
            if (status.includes('Cooldown') || status.includes('‚è≥')) return 'bg-blue-100 text-blue-800';
            if (status.includes('Login') || status.includes('üîë')) return 'bg-yellow-100 text-yellow-800';
            return 'bg-gray-100 text-gray-800';
        }

        // Check monitoring status on page load
        async function checkMonitoringStatus() {
            try {
                const response = await fetch(`${API_URL}/api/status`);
                const data = await response.json();
                
                if (data.monitoring_active) {
                    monitoringActive = true;
                    updateButtons();
                    addLog('‚úÖ Monitoring is already running');
                } else {
                    monitoringActive = false;
                    updateButtons();
                }
            } catch (error) {
                console.error('Error checking monitoring status:', error);
            }
        }

        // Update countdown timers every second
        function updateCountdowns() {
            const instanceCards = document.querySelectorAll('[data-instance-id]');
            instanceCards.forEach(card => {
                const instanceId = card.getAttribute('data-instance-id');
                const countdownElement = card.querySelector(`[data-countdown="${instanceId}"]`);
                
                if (countdownElement) {
                    let seconds = parseInt(card.getAttribute('data-seconds') || '0');
                    const retryType = card.getAttribute('data-retry-type') || null;
                    
                    if (seconds > 0) {
                        seconds--;
                        card.setAttribute('data-seconds', seconds);
                        countdownElement.textContent = formatCountdown(seconds, retryType);
                        
                        // Update color based on retry type and remaining time
                        if (seconds > 0) {
                            if (retryType === 'technical') {
                                countdownElement.className = 'font-semibold text-orange-600';
                            } else {
                                countdownElement.className = 'font-semibold text-blue-600';
                            }
                        } else {
                            countdownElement.className = 'font-semibold text-green-600';
                        }
                    }
                }
            });
        }
        
        // Start polling
        function startPolling() {
            updateStatistics();
            updateInstances();
            
            setInterval(updateStatistics, 5000);
            setInterval(updateInstances, 5000);
            setInterval(updateCountdowns, 1000);  // Update countdown every second
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked button
            event.target.closest('.tab-btn').classList.add('active');
            
            // Load sessions if sessions tab
            if (tabName === 'sessions') {
                loadSessions();
            }
            
            // Load browsers if browsers tab
            if (tabName === 'browsers') {
                loadBrowsers();
            }
            
            // Load login required instances if login-required tab
            if (tabName === 'login-required') {
                loadLoginRequiredInstances();
            }
        }

        // Load sessions
        async function loadSessions() {
            try {
                const response = await fetch(`${API_URL}/api/sessions`);
                const data = await response.json();
                
                const sessionsList = document.getElementById('sessions-list');
                const sessionsCount = document.getElementById('sessions-count');
                
                if (data.sessions && data.sessions.length > 0) {
                    sessionsCount.textContent = `${data.sessions.length} sessions`;
                    
                    sessionsList.innerHTML = data.sessions.map(session => `
                        <div class="session-card">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Instance #${session.instance_id}</h3>
                                    <p class="text-sm text-gray-600">IP: ${session.ip}</p>
                                </div>
                                <span class="status-badge ${getSessionStatusColor(session.status)}">
                                    ${getSessionStatusText(session.status)}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-3">
                                <div>‚úÖ Last Success: ${formatLastVote(session.last_successful_vote)}</div>
                                <div>üéØ Last Attempt: ${formatLastVote(session.last_attempted_vote)}</div>
                            </div>
                            <div class="text-sm text-gray-600 mb-3">
                                <div>üìä Total Votes: ${session.vote_count}</div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="launchInstance(${session.instance_id})" 
                                    class="flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition-colors">
                                    üöÄ Launch
                                </button>
                                <button onclick="checkLogin(${session.instance_id})" 
                                    class="flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg transition-colors">
                                    üîç Check Login
                                </button>
                                <button onclick="saveLogin(${session.instance_id})" 
                                    class="flex-1 px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg transition-colors">
                                    üíæ Save Login
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    sessionsCount.textContent = '0 sessions';
                    sessionsList.innerHTML = '<p class="text-center text-gray-500 py-8">No saved sessions found</p>';
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                addLog('‚ùå Failed to load sessions');
            }
        }

        // Launch instance
        async function launchInstance(instanceId) {
            try {
                addLog(`üöÄ Launching instance #${instanceId}...`);
                
                const response = await fetch(`${API_URL}/api/launch-instance/${instanceId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    addLog(`‚úÖ ${data.message}`);
                    alert(data.message);
                } else {
                    addLog(`‚ö†Ô∏è ${data.message}`);
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error launching instance:', error);
                addLog(`‚ùå Failed to launch instance #${instanceId}`);
                alert('Failed to launch instance');
            }
        }

        // Check login
        let checkingLogin = {};
        async function checkLogin(instanceId) {
            if (checkingLogin[instanceId]) {
                alert('Already checking login for this instance');
                return;
            }
            
            try {
                checkingLogin[instanceId] = true;
                addLog(`üîç Checking login for instance #${instanceId}...`);
                
                const response = await fetch(`${API_URL}/api/check-login/${instanceId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    if (data.logged_in) {
                        addLog(`‚úÖ Instance #${instanceId}: ${data.message}`);
                        alert(`‚úÖ Instance #${instanceId} is logged in!`);
                    } else {
                        addLog(`‚ö†Ô∏è Instance #${instanceId}: ${data.message}`);
                        alert(`‚ö†Ô∏è Instance #${instanceId} requires re-login`);
                    }
                    loadSessions(); // Refresh sessions list
                } else {
                    addLog(`‚ùå ${data.message}`);
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error checking login:', error);
                addLog(`‚ùå Failed to check login for instance #${instanceId}`);
                alert('Failed to check login');
            } finally {
                checkingLogin[instanceId] = false;
            }
        }

        // Save login
        let currentLoginInstance = null;
        async function saveLogin(instanceId) {
            try {
                currentLoginInstance = instanceId;
                addLog(`üíæ Opening browser for instance #${instanceId}...`);
                
                const response = await fetch(`${API_URL}/api/save-login/${instanceId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                
                if (data.status === 'browser_opened') {
                    addLog(`‚úÖ Browser opened for instance #${instanceId} - Please complete Google login`);
                    showSaveLoginModal();
                } else {
                    addLog(`‚ùå ${data.message}`);
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error opening login browser:', error);
                addLog(`‚ùå Failed to open browser for instance #${instanceId}`);
                alert('Failed to open browser');
            }
        }

        // Show save login modal
        function showSaveLoginModal() {
            const modal = document.getElementById('save-login-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Hide save login modal
        function hideSaveLoginModal() {
            const modal = document.getElementById('save-login-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Complete login
        async function completeLogin() {
            if (!currentLoginInstance) {
                alert('No active login session');
                return;
            }
            
            try {
                addLog(`üíæ Saving session for instance #${currentLoginInstance}...`);
                
                const response = await fetch(`${API_URL}/api/save-login/${currentLoginInstance}/complete`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    addLog(`‚úÖ ${data.message}`);
                    alert(data.message);
                    hideSaveLoginModal();
                    loadSessions(); // Refresh sessions list
                    currentLoginInstance = null;
                } else {
                    addLog(`‚ùå ${data.message}`);
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error completing login:', error);
                addLog(`‚ùå Failed to save session`);
                alert('Failed to save session');
            }
        }

        // Helper functions
        function getSessionStatusColor(status) {
            if (status === 'saved') return 'bg-green-100 text-green-800';
            if (status === 'needs_login') return 'bg-yellow-100 text-yellow-800';
            return 'bg-gray-100 text-gray-800';
        }

        function getSessionStatusText(status) {
            if (status === 'saved') return '‚úÖ Saved';
            if (status === 'needs_login') return '‚ö†Ô∏è Needs Login';
            return '‚ùì Unknown';
        }

        function formatLastVote(lastVote) {
            if (!lastVote || lastVote === 'Never') return 'Never';
            try {
                const date = new Date(lastVote);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                
                if (diffMins < 60) return `${diffMins} min ago`;
                if (diffHours < 24) return `${diffHours} hours ago`;
                return `${Math.floor(diffHours / 24)} days ago`;
            } catch {
                return lastVote;
            }
        }

        // Load browsers
        async function loadBrowsers() {
            try {
                const response = await fetch(`${API_URL}/api/browsers`);
                const data = await response.json();
                
                const browsersList = document.getElementById('browsers-list');
                const browsersCount = document.getElementById('open-browsers-count');
                
                if (data.browsers && data.browsers.length > 0) {
                    browsersCount.textContent = data.browsers.length;
                    
                    browsersList.innerHTML = data.browsers.map(browser => `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <h3 class="text-lg font-semibold text-gray-900">Instance #${browser.instance_id}</h3>
                                        <span class="status-badge ${browser.browser_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                            ${browser.browser_active ? 'üü¢ Active' : '‚ö´ Inactive'}
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                                        <div>
                                            <span class="font-medium">IP:</span> ${browser.ip || 'N/A'}
                                        </div>
                                        <div>
                                            <span class="font-medium">Status:</span> ${browser.status || 'Unknown'}
                                        </div>
                                        <div>
                                            <span class="font-medium">Votes:</span> ${browser.vote_count || 0}
                                        </div>
                                        <div>
                                            <span class="font-medium">Browser Open:</span> ${browser.browser_open_duration || '0s'}
                                        </div>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <button 
                                        onclick="forceCloseBrowser(${browser.instance_id})" 
                                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors flex items-center space-x-2"
                                        ${!browser.browser_active ? 'disabled' : ''}
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                        <span>Force Close</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    browsersCount.textContent = '0';
                    browsersList.innerHTML = '<p class="text-center text-gray-500 py-8">No browsers currently open</p>';
                }
            } catch (error) {
                console.error('Error loading browsers:', error);
                document.getElementById('browsers-list').innerHTML = '<p class="text-center text-red-500 py-8">Failed to load browsers</p>';
            }
        }

        // Force close browser
        async function forceCloseBrowser(instanceId) {
            if (!confirm(`Are you sure you want to force close browser for Instance #${instanceId}?`)) {
                return;
            }
            
            try {
                addLog(`üî¥ Force closing browser for instance #${instanceId}...`);
                
                const response = await fetch(`${API_URL}/api/force-close-browser/${instanceId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    addLog(`‚úÖ ${data.message}`);
                    loadBrowsers(); // Refresh browsers list
                } else {
                    addLog(`‚ùå ${data.message}`);
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error force closing browser:', error);
                addLog(`‚ùå Failed to force close browser for instance #${instanceId}`);
                alert('Failed to force close browser');
            }
        }

        // Auto-refresh browsers list when tab is active
        setInterval(() => {
            const browsersTab = document.getElementById('browsers-tab');
            if (browsersTab && browsersTab.classList.contains('active')) {
                loadBrowsers();
            }
        }, 3000); // Refresh every 3 seconds

        // Load login required instances
        async function loadLoginRequiredInstances() {
            try {
                const response = await fetch(`${API_URL}/api/login-required-instances`);
                const data = await response.json();
                
                const loginRequiredList = document.getElementById('login-required-list');
                const loginRequiredCount = document.getElementById('login-required-instances-count');
                
                if (data.instances && data.instances.length > 0) {
                    loginRequiredCount.textContent = data.instances.length;
                    
                    loginRequiredList.innerHTML = data.instances.map(instance => `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <h3 class="text-lg font-semibold text-gray-900">Instance #${instance.instance_id}</h3>
                                        <span class="status-badge bg-red-100 text-red-800">
                                            üîí Login Required
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-3">
                                        <div>
                                            <span class="font-medium">IP:</span> ${instance.ip || 'N/A'}
                                        </div>
                                        <div>
                                            <span class="font-medium">Status:</span> ${instance.status || 'Unknown'}
                                        </div>
                                        <div>
                                            <span class="font-medium">Votes:</span> ${instance.vote_count || 0}
                                        </div>
                                        <div>
                                            <span class="font-medium">Detected:</span> ${instance.login_detected_time || 'Unknown'}
                                        </div>
                                    </div>
                                    <div class="bg-white border border-red-200 rounded p-2 text-sm">
                                        <span class="font-medium text-red-700">Reason:</span>
                                        <span class="text-gray-700">${instance.login_detection_reason || 'Login with Google button detected'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    loginRequiredCount.textContent = '0';
                    loginRequiredList.innerHTML = '<p class="text-center text-gray-500 py-8">No instances require login</p>';
                }
            } catch (error) {
                console.error('Error loading login required instances:', error);
                document.getElementById('login-required-list').innerHTML = '<p class="text-center text-red-500 py-8">Failed to load login required instances</p>';
            }
        }

        // Auto-refresh login required list when tab is active
        setInterval(() => {
            const loginRequiredTab = document.getElementById('login-required-tab');
            if (loginRequiredTab && loginRequiredTab.classList.contains('active')) {
                loadLoginRequiredInstances();
            }
        }, 5000); // Refresh every 5 seconds

        // Modal event listeners
        document.getElementById('cancel-login-btn').addEventListener('click', hideSaveLoginModal);
        document.getElementById('complete-login-btn').addEventListener('click', completeLogin);
    </script>
</body>
</html>
